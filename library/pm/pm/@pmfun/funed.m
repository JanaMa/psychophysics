function [] = funed(fun,varargin)
%FUNED PM function specification editor.
%   FUNED(PMFUN), where PMFUN is a PMFUN object. This will start a function
%   editor and give back the user the control of the Matlab console.
%
%  Warning: If a 'clear all' command is issued while the FUNED editor is
%  open, the function will be corrupt and errors will occur. Clear by
%  itself is ok.  
%  If the function editor is exited in an abnormal way, use 'clear pmfun'
%  to be able to start over. 
  
% a faire
%
%
% the actual function to be edited is persistent, the fun that is given
% as an argument is only used at initiation. The real function can be
% very extensive and because it is modified at each call, its pointer is
% not passed but instead the complete object. This has the bug that it is
% sensible to CLEAR ALL. One way of solving this could be to look into
% SETAPPDATA

persistent FUN
if nargin == 1
  % initialise
  h0 = get(0,'children');
  for fig = h0'
    if strcmp(get(fig,'name'),'Funed');
      figure(fig);
      % it exists already! 
      if strcmp('Yes',questdlg(['The function editor is already active,' ...
		    ' overwrite current function?'],'Overwrite?','Yes','No','No'))
	FUN = fun;
	funed(pmfun,'refresh fun');
	funed(pmfun,'refresh block', gcf)
      end
      return
    end
  end
  initialise;
  FUN = fun;
  funed(pmfun,'refresh fun');
  funed(pmfun,'refresh block', gcf)

else
  switch varargin{1}
   
   % REFRESH
   %--------
   case 'refresh fun'

    %FUN % DEBUG
    set(findobj(gcf,'Tag','expredit'),'String',FUN.pmrpcfun.expr)
    set(findobj(gcf,'Tag','preexpredit'),'String',FUN.prefun)
    set(findobj(gcf,'Tag','postexpredit'),'String',FUN.postfun)
    % refresh list of inargs
    h_inl = findobj(gcf,'Tag','inlist');
    list = [];
    for n=1:length(FUN.comarg)
      if ischar(FUN.comdata{n})
	d = FUN.comdata{n};
      else
	s = size(FUN.comdata{n});
	if prod(s)>1 | iscell(FUN.comdata{n}) | isstruct(FUN.comdata{n}) ...
	      | isobject(FUN.comdata{n})
	  d = [class(FUN.comdata) ' ' int2str(s)];
	else
 	  d = int2str(FUN.comdata{n});
	end
      end	  
      list{end+1} = [FUN.comarg{n} '    COMMON, ' d];
    end   
    
    % continued refresh of input args.
    for n=1:length(FUN.pmrpcfun.argin)
      list{end+1} = [FUN.pmrpcfun.argin{n} '    SPECIFIC, ' FUN.datain{n}];
    end
    set(h_inl,'Max',length(list),'String',list,'Value',1)

    % refresh output args
    h_outl = findobj(gcf,'Tag','outlist');
    list = [];
    for n=1:length(FUN.pmrpcfun.argout)
      list{end+1} = [FUN.pmrpcfun.argout{n} '    ' FUN.dataout{n}];
    end
    set(h_outl,'Max',length(FUN.pmrpcfun.argout),'String',list,'Value',1)
%    funed(pmfun,'refresh block',gcf)
    
   %--------
   case 'refresh block'
    
    %if ~isempty(FUN.blocks), FUN.blocks(1),end % DEBUG
    % refresh block information
    h_attrpop = findobj(varargin{2},'Tag','attrpopup');
    attr = {};
    if ~isempty(FUN.blocks)
      field = fieldnames(FUN.blocks);
      for f_cnt=1:length(field)
	for n=1:length(getfield(FUN.blocks(1),field{f_cnt}));
	  attr = [attr ; {[field{f_cnt} '(' int2str(n) ')']}];
	end
      end
    end
    attr = [attr ; {'New'}];
    v = get(h_attrpop,'Value');
    set(h_attrpop,'String',attr,'Max',length(attr),'Value',min(length(attr),v));
    set(findobj(varargin{2},'Tag','numblockstext'), ...
	'String',int2str(size(FUN.blocks,1)), ...
	'UserData',size(FUN.blocks,1));
	
   %--------
   case 'new'
    
    FUN = pmfun;
    funed(pmfun,'refresh fun')
   
   %--------
   case 'import fun'
 
    name = inputdlg({'Enter variable name'},'Import variable', 1, {''});
    badname = 0;
    while ~isempty(name)
      if evalin('caller',['~exist(''' name{1} ''')'])
	badname = 1;
      else
	if evalin('caller',['~isa(' name{1} ',''pmfun'')'])
	  badname = 1;
	end
      end
      if badname
	name = inputdlg({['Variable does not exist or is not a PMFUN, enter ' ...
			'new variable name']}, 'Import variable', 1, {''});
      else
	FUN=evalin('caller',name{1});
	funed(pmfun,'refresh fun')
	break
      end
    end
 
    
   %--------
   case 'export fun'
    
    name=inputdlg({'Enter variable name'},'Export variable', 1, {''});
    if ~isempty(name)
      assignin('caller', name{1}, FUN);
    end
   
   %--------
   case 'exit'
   
    if strcmp('No',questdlg(['Are you sure you want to exit the PM ' ...
		    'function editor?'], 'Exit Funed?','Yes','No','Yes'))
      return
    end
    FUN = [];
    h0 = get(0,'children');
    for fig = h0'
      if any(strcmp(get(fig,'name'),{'Index Creator', 'Filename Creator'}));
	close(fig);
      end
    end
    closereq;
    
   %--------
   case 'store expr'
    
    FUN.pmrpcfun.expr = get(findobj(gcf,'Tag','expredit'),'String');

    %--------
   case 'store preexpr'
    
    FUN.prefun = get(findobj(gcf,'Tag','preexpredit'),'String');

    %--------
   case 'store postexpr'
    
    FUN.postfun = get(findobj(gcf,'Tag','postexpredit'),'String');
    
   %--------
   case 'add inarg'
   
    [cancel,name,when,source,ind] = inselectgui;
    if ~cancel
      try,
	if when == 1 %% common
	  gb_inds = (strmatch('GETBLOC',FUN.datain));
	  ind = ind + length(unique(FUN.datain(gb_inds)));
	  FUN = addcominput(FUN,name,source,ind);
	  funed(pmfun,'refresh fun')
	else %specific
	  FUN = addspecinput(FUN,name,source,ind);
	  funed(pmfun,'refresh fun')
	  switch source
	   case {'GETBLOC' 'SRC'}
	    createindgui('src',ind,size(FUN.blocks,1))
	   case {'DST'}
	    createindgui('dst',ind,size(FUN.blocks,1))
	   case {'LOADFILE' 'SRCFILE'}
	     createfnamegui('srcfile',ind,size(FUN.blocks,1))
	   case 'DSTFILE'
	    createfnamegui('dstfile',ind,size(FUN.blocks,1))
	   case 'USERDATA'
	    createattr('userdata',ind)
	  end
	end
      catch,
	msgbox(lasterr,'Error when deleting output argument','error','modal');
      end
    end
    
   %--------
%   case 'modify inarg'
%   
%    Reserved for future use. There's also a button ready made but commented.
   
   %--------
   case 'delete inarg'
    
    h_inpop = findobj(gcf,'Tag','inlist');
    v = get(h_inpop,'Value');
    s = get(h_inpop,'String');
    if ~isempty(s)
      name = strtok(s{v}); 
      try, 
	FUN = delspecinput(FUN,name); 
      catch,
	FUN = delcominput(FUN,name);
      end
      funed(pmfun,'refresh fun')
      funed(pmfun,'refresh block',gcf)
    end
    
    %--------
   case 'add outarg'
    
    [cancel,name,dest,ind] = outselectgui;
    if ~cancel
      try,
	FUN = addoutput(FUN,name,dest,ind);
	funed(pmfun,'refresh fun')
	switch dest
	 case {'SETBLOC'}
	  createindgui('dst',ind,size(FUN.blocks,1))
	 case {'SAVEFILE'}
	  createfnamegui('dstfile',ind,size(FUN.blocks,1))
	end
	funed(pmfun,'refresh block',gcbo)
      catch,
	msgbox(lasterr,'Error when adding output argument','error','modal');
      end
    end
    
   %--------
%   case 'modify outarg'
%
%    Reserved for future use. There is also a button ready made but commented.

   %--------
   case 'delete outarg'
    
    h_outpop = findobj(gcf,'Tag','outlist');
    v = get(h_outpop,'Value');
    s = get(h_outpop,'String');
    if ~isempty(s)
      name = strtok(s{v});
      try, 
	FUN = deloutput(FUN,name);
	funed(pmfun,'refresh fun')
	funed(pmfun,'refresh block',gcf)
      catch,
	msgbox(lasterr,'Error when deleting output argument','error','modal');
      end
    end

   %--------
   case 'view attr' 

    h_pop = findobj(gcf,'Tag','attrpopup');
    v = get(h_pop,'Value');
    m = get(h_pop,'Max');
    s = get(h_pop,'String');
    if v~=m
      if ~isempty(FUN.blocks)
	[fld,ind] = strtok(s{v},'(');
	assignin('caller','ans',getattr(FUN.blocks,fld,str2num(ind)))
	evalin('caller','ans')
      end	  
    end
    
   %--------
   case 'set attr'

    h_pop = findobj(gcf,'Tag','attrpopup');
    v = get(h_pop,'Value');
    m = get(h_pop,'Max');

    if v == m
      fields = fieldnames(pmblock);
      [v,ok] = listdlg('PromptString',{'Select an attribut to add to block:'},...
		       'SelectionMode','single',...
		       'Name','Add block spec', ...
		       'ListString',fields);
      if ~ok
	return
      end
      
      if isempty(FUN.blocks)
	ind = 1;
      else
	ind = 1+size(eval(['FUN.blocks(1).' fields{v}]),2);
      end
      attr = fields{v};
    else
      s = get(h_pop,'String');
      [attr,ind] = strtok(s{v},'(');
      ind = str2num(ind);
    end
    switch attr
     case {'src', 'dst'}
      createindgui(attr,ind,size(FUN.blocks,1))
     case {'srcfile', 'dstfile'}
      createfnamegui(attr,ind,size(FUN.blocks,1))
     case {'timeout' 'userdata'}
      createattr(attr,ind)
     otherwise
    end
      
   %--------
   case 'delete attr'

    h_pop = findobj(gcf,'Tag','attrpopup');
    v = get(h_pop,'Value');
    m = get(h_pop,'Max');
    if m == 2 % we are deleting the last value
      FUN.blocks = [];
    elseif v<m,
      s = get(h_pop,'String');
      eval(['for n=1:size(FUN.blocks,1),FUN.blocks(n).' s{v} '=[];end'])
    end
    funed(pmfun,'refresh block', gcf)
        
   %--------
   case 'inselect source'
    setsource(get(findobj(gcf,'Tag','whenpopup'),'Value'));
    funed(pmfun,'inselect index')
    
   %--------
   case 'inselect index'
      
    v = get(findobj(gcf,'Tag','sourcepopup'),'Value');
    h_when = findobj(gcf,'Tag','whenpopup');
    h_ind = findobj(gcf,'Tag','indexpopup');
    when = get(h_when,'Value');
    if when == 1 % common input
      switch v
       case {1,2} % LOAD or INPUT
	% get the argument names for the data that is not given directly.       
	data = {}; 
	for n=1:length(FUN.comdata)
	  if ischar(FUN.comdata{n})
	    data(end+1) = FUN.comdata(n);
	  end
	end
	fil=[strmatch('LOAD',data) ; strmatch('INPUT',data)];
	inds = getindsforpopup(fil,data);	
      end
    elseif when == 2 % specific input
      switch v
       case {1,7} % LOADFILE, SRCFILE 
	% find how many indices exist for LOADFILE and SRCFILE in datain
	data = {};
	for n=1:length(FUN.datain)
	  if ischar(FUN.datain{n})
	    data(end+1) = FUN.datain(n);
	  end
	end
	src=[strmatch('LOADFILE',data);strmatch('SRCFILE',data)];
	inds = getindsforpopup(src,data);
       case 2 % GETBLOC
	% find how many GETBLOC there are.
	data = {};
	for n=1:length(FUN.datain)
	  if ischar(FUN.datain{n})
	    data(end+1) = FUN.datain(n);
	  end
	end
	src=strmatch('GETBLOC',data);
	inds = getindsforpopup(src,data);
       case 3 % USERDATA
	% find how many USERDATA there are.
	data = {};
	for n=1:length(FUN.datain)
	  if ischar(FUN.datain{n})
	    data(end+1) = FUN.datain(n);
	  end
	end
	src=strmatch('USERDATA',data);
	inds = getindsforpopup(src,data);
      case 5 % SRC
	% find how many GETBLOC and SRC there are.
	data = {};
	for n=1:length(FUN.datain)
	  if ischar(FUN.datain{n})
	    data(end+1) = FUN.datain(n);
	  end
	end
	src=[strmatch('GETBLOC',data);strmatch('SRC(',data)];
	inds = getindsforpopup(src,data);
       case 6 % DST
	both = [FUN.datain FUN.dataout];
	data = {};
	for n=1:length(both)
	  if ischar(both{n})
	    data(end+1) = both(n);
	  end
	end
	dst=[strmatch('DST(',data) ; strmatch('SETBLOC',data)];
	inds = getindsforpopup(dst,data);
       case 8 % DSTFILE
	both = [FUN.datain FUN.dataout];
	data = {};
	for n=1:length(both)
	  if ischar(both{n})
	    data(end+1)= both(n);
	  end
	end
	dst=[strmatch('DSTFILE',data);strmatch('SAVEFILE',data)];
	inds = getindsforpopup(dst,data);
       otherwise
	msgbox('Not a valid selection. Choose one of the 4 below','Input Error','error','modal');
	set(findobj(gcbo,'Tag','sourcepopup'),'Value',1);
	data = {};
	for n=1:length(FUN.datain)
	  if ischar(FUN.datain{n})
	    data(end+1) = FUN.datain(n);
	  end
	end
	src=[strmatch('LOADFILE',data);strmatch('SRCFILE',data)];
	inds = getindsforpopup(src,data);
      end
    end
    set(h_ind,'String',inds,'Max',length(inds),'Value',length(inds));    
   
   %--------
   case 'outselect index'
    
    v = get(findobj(gcf,'Tag','destpopup'),'Value'); 
    switch v
     case 1 % SAVEFILE
      src = [strmatch('SAVEFILE',FUN.dataout); strmatch('DSTFILE',[FUN.dataout FUN.datain])]; 
     case 2 % SETBLOC
      src = strmatch('SETBLOC',FUN.dataout);
    end
    inds = getindsforpopup(src,[FUN.dataout FUN.datain]);
    h_ind = findobj(gcf,'Tag','indexpopup');
    set(h_ind,'String',inds,'Max',length(inds),'Value',length(inds));    
  
   %------
   case 'index split'

    %varargin{2} contains the object handle for the createindsgui UI.
    
    if get(findobj(varargin{2},'Tag','indexradio1'),'Value'),
      try
	var = get(findobj(varargin{2},'tag','wspopup'),'String');
	var = var{get(findobj(varargin{2},'tag','wspopup'),'Value')};
	s = evalin('caller',var);
      catch
	msgbox(lasterr,'Input Error','error','modal');
        return
      end
    else
      dim = eval(get(findobj(varargin{2},'Tag','indexdimedit'),'String'));
      if get(findobj(varargin{2},'Tag','matrixtypepopup'),'Value')==1
	s = repmat(0,dim);
      else
	s = cell(dim);
      end
    end 
    inds=createinds(s,eval(get(findobj(varargin{2},'Tag','blockdimedit'),'String')));
    set(findobj(varargin{2},'Tag','viewbut'),'Enable','on')
    set(findobj(varargin{2},'Tag','commitbut'),'Enable','on')
    set(findobj(varargin{2},'Tag','numdimtext'),'String','')
    set(findobj(varargin{2},'Tag','numblocktext'),'String',int2str(size(inds,1)))
    set(findobj(varargin{2},'Tag','donebut'),'UserData',1)
    h_outptext = findobj(varargin{2},'Tag','outptext');
    set(h_outptext,'String',strtok(get(h_outptext,'String')));
    set(varargin{2},'UserData',inds)    
    
   %--------
   case 'fname create'
    h_file = findobj(varargin{2},'Tag','fileedit');
    h_src = findobj(varargin{2},'Tag','filesourceradio2');
    h_ext = findobj(varargin{2},'Tag','extedit');
    try 
      fnames = createfnames(get(h_src,'Value'), ...
			    get(h_file,'String'), ...
			    get(h_ext,'String'));
    catch 
      msgbox(lasterr,'Infile Specification Error','error','modal');
    end
    set(findobj(varargin{2},'Tag','viewbut'),'Enable','on')
    set(findobj(varargin{2},'Tag','commitbut'),'Enable','on')
    set(findobj(varargin{2},'Tag','numblockstext'),'String',int2str(size(fnames,1)))
    set(findobj(varargin{2},'Tag','donebut'),'UserData',1)
    h_outptext = findobj(varargin{2},'Tag','outptext');
    set(h_outptext,'String',strtok(get(h_outptext,'String')));
    set(varargin{2},'UserData',fnames)    
 
   %--------
   case 'fname browse'

    [filename,pathname] = uigetfile('*.*','Input');                     
    if filename ~= 0                                                    
      set(findobj(varargin{2},'Tag','fileedit'),'String',[pathname filename])
    end   
    
   %------
   case 'attr commit'
    
    % varargin{2} is the handle of the source window that must contain:
    %
    % an object with tag 'outptext' that has the userdata containing
    % the index, and the string containing the 'ATTR(ind)'
    % 
    % an object with tag 'donebut'

    h0 = get(0,'children');
    % find main window.
    for fig = h0'
      if strcmp(get(fig,'name'),'Funed');
	break;
      end
    end
    inds = get(varargin{2},'UserData');
    h_numblocks = findobj(fig,'tag','numblockstext');
    if get(h_numblocks,'UserData') & size(inds,1) ~= get(h_numblocks,'UserData')
      msgbox(['Cannot commit a different number of attributes than the one' ...
	      ' already defined by the existing number of blocks. To create ' ...
	      'different number of blocks, the existing blocks must first be deleted.'],...
	      'Attribute Commit Error','error','modal');
      return
    end
      
    h_outptext = findobj(varargin{2},'tag','outptext');
    outptext = get(h_outptext,'String');
    field = lower(strtok(outptext,'('));
    ind = get(h_outptext,'UserData');
    if isempty(FUN.blocks)
      FUN.blocks = pmblock(size(inds,1));
    end
    FUN.blocks = setattr(FUN.blocks,field,ind,inds);
    set(h_outptext,'String',[strtok(outptext) ' Committed']);  
    set(findobj(varargin{2},'Tag','donebut'),'UserData',0)
    
    funed(pmfun,'refresh block',fig)
   
   
   otherwise
    error('illegal call of funed')
  end 
end

   
%--------
function inds = getindsforpopup(word_ind,data)
  inds = [];
  for n=1:length(word_ind)
    [t,r] = strtok(data{word_ind(n)},'(');
    inds{end+1} = r;
    inds = unique(inds);
  end
  inds{end+1} = 'New';
  

%--------
function [] = createattr(attr,ind)
  try,
    a=inputdlg({['Give an expression that will be evaluated in the user' ...
		 ' workspace. The result from evaluating this expression' ...
		 ' must be a vector where each entry will be placed in the' ...
		 ' chosen attribute and index of each of the blocks. ' ...
		 ' For userdata it must be a vector of cells.']},  ...
	     ['Set block attribute: ' attr '(' int2str(ind) ')'], ...
	     [1 40],{''},'off');
    if isempty(a)
      return
    end
    data = evalin('base',a{1});
    data = data(:);
    b = evalin('caller','FUN.blocks');
    if isempty(b)
      b = pmblock(size(data,1));
    end
    assignin('caller','blocks_tmp',setattr(b,attr,ind,data));
    evalin('caller','FUN.blocks=blocks_tmp;');
    funed(pmfun,'refresh block',gcf)    
  catch,
    msgbox(lasterr,'Attribute Create Error','error','modal');
  end
  

%--------
function setsource(v)
  h_src = findobj(gcf,'Tag','sourcepopup');
  if v == 1
    set(h_src,'String',{'LOAD','INPUT'},'Value',1);
  elseif v == 2
    set(h_src,'String',{'LOADFILE','GETBLOC','USERDATA', '--DEBUG--' ...
			'SRC','DST','SRCFILE','DSTFILE'},'Value',1);
  end
  
%--------
function [] = initialise()
  
%	'Position',[686 332 465 445], ...
%   'Position', [255 101 498 472], ...
  
h0 = figure('Color',[0.8 0.8 0.8], ...
	'MenuBar','none', ...
	'Name','Funed', ...
	'NumberTitle','off', ...
   'Position', [255 101 498 472], ...
   'PaperPosition',[18 180 576 432], ...
	'PaperUnits','points', ...
	'Tag','Fig1'); %, ...
%	'ToolBar','none');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'Callback','funed(pmfun,''store expr'')', ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[16 312 340 20.8], ...
	'Style','edit', ...
	'Tag','expredit', ...
	'TooltipString','Expression that will be evaluated on Matlab slave instances.');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[12 336 112 12], ...
	'String','Expression to evaluate', ...
	'Style','text', ...
	'Tag','StaticText1');
% input arguments
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'Max',0, ...
	'Position',[16 244 204 52], ...
	'Style','listbox', ...
	'Tag','inlist', ...
	'Value',1);
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''add inarg'')', ...
	'Interruptible','off', ...
	'ListboxTop',0, ...
	'Position',[224 280 48 16], ...
	'String','Add ...', ...
	'Tag','inaddbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[12 296 84 16], ...
	'String','Input arguments', ...
	'Style','text', ...
	'Tag','StaticText1');
%h1 = uicontrol('Parent',h0, ...
%	'Units','points', ...
%	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
%	'Callback','funed(pmfun,''modify inarg'')', ...
%	'Interruptible','off', ...
%	'ListboxTop',0, ...
%	'Position',[224 248 48 16], ...
%	'String','Modify ...', ...
%	'Tag','inmodbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''delete inarg'')', ...
	'Interruptible','off', ...
	'ListboxTop',0, ...
	'Position',[224 264 48 16], ...
	'String','Delete', ...
	'Tag','indelbut');
% output arguments
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'Max',0, ...
	'Position',[16 176 204 52], ...
	'Style','listbox', ...
	'Tag','outlist', ...
	'Value',1);
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''add outarg'')', ...
	'Interruptible','off', ...
	'ListboxTop',0, ...
	'Position',[224 212 48 16.8], ...
	'String','Add ...', ...
	'Tag','outaddbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[12 228 83.2 16], ...
	'String','Output arguments', ...
	'Style','text', ...
	'Tag','StaticText1');
%h1 = uicontrol('Parent',h0, ...
%	'Units','points', ...
%	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
%	'Callback','funed(pmfun,''modify outarg'')', ...
%	'Interruptible','off', ...
%	'ListboxTop',0, ...
%	'Position',[224 180 48 16], ...
%	'String','Modify ...', ...
%	'Tag','outmodbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''delete outarg'')', ...
	'Interruptible','off', ...
	'ListboxTop',0, ...
	'Position',[224 196 48 16], ...
	'String','Delete', ...
	'Tag','outdelbut');

% block attributes
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'ListboxTop',0, ...
	'Position',[12 16 284 48], ...
	'Style','frame', ...
	'Tag','Frame1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Min',1, ...
	'Position',[16 24 96 20], ...
	'String',' ', ...
	'Style','popupmenu', ...
	'Tag','attrpopup', ...
	'Value',1);
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''view attr'')', ...
	'ListboxTop',0, ...
	'Position',[116 28 52 16], ...
	'String','View', ...
	'Tag','attrviewbut', ...
	'TooltipString','Push to view attributes in base workspace');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''delete attr'')', ...
	'ListboxTop',0, ...
	'Position',[228 28 52 16], ...
	'String','Delete', ...
	'Tag','attrdelbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''set attr'')', ...
	'ListboxTop',0, ...
	'Position',[172 28 52 16], ...
	'String','Set ...', ...
	'Tag','attrsetbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[16 44 83.2 16], ...
	'String','Block attributes', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[12 68 172 16], ...
	'String','Number of blocks defined for function:', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[180 68 92 16], ...
	'String','0', ...
	'Style','text', ...
	'Tag','numblockstext');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'ListboxTop',0, ...
	'Position',[296 232 60 64], ...
	'Style','frame', ...
	'Tag','Frame1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''new'')', ...
	'Interruptible','off', ...
	'ListboxTop',0, ...
	'Position',[300 276 48 16], ...
	'String','New', ...
	'Tag','newbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''import fun'')', ...
	'Interruptible','off', ...
	'ListboxTop',0, ...
	'Position',[300 256 48 16], ...
	'String','Import ...', ...
	'Tag','importbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''export fun'')', ...
	'Interruptible','off', ...
	'ListboxTop',0, ...
	'Position',[300 236 48 16], ...
	'String','Export ...', ...
	'Tag','exportbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''exit'')', ...
	'Interruptible','off', ...
	'ListboxTop',0, ...
	'Position',[300 180 48 16], ...
	'String','Exit', ...
	'Tag','exitbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[12 148 196 16], ...
	'String','Expression to evaluate before dispatching', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'Callback','funed(pmfun,''store preexpr'')', ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[16 128 340 20.8], ...
	'Style','edit', ...
	'Tag','preexpredit');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[12 112 256 16], ...
	'String','Expression to evaluate when dispatching completed', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'Callback','funed(pmfun,''store postexpr'')', ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[16 92 340 20.8], ...
	'Style','edit', ...
	'Tag','postexpredit', ...
	'TooltipString','Press enter when done');

% inselectgui
%------------

function [cancel,name,when,source,ind] = inselectgui(name,when,source,ind)
  
if nargin == 0
  ind = 1;
  source = 1;
  when = 1;
  name = '';
end

cancel = 1;

h0 = figure('Units','points', ...
	'Color',[0.8 0.8 0.8], ...
	'MenuBar','none', ...
	'Name','Select input source', ...
	'NumberTitle','off', ...
	'PaperPosition',[18 180 576 432], ...
	'PaperUnits','points', ...
	'Position',[235.2 325.6 196.8 138.4], ...
	'Tag','inselect', ...
	'WindowStyle','modal'); %, ...
%	'ToolBar','none');
h_name = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 96 108 20], ...
	'String',name, ...
	'Style','edit', ...
	'Tag','varname', ...
	'TooltipString','Name that the data will take on slave matlab instance');
h_when = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''inselect source'')', ... 
	'ListboxTop',0, ...
	'Max',2, ...
	'Min',1, ...
	'Position',[8 56 108 20], ...
	'String',{'Common','Specific'}, ...
	'Style','popupmenu', ...
	'Tag','whenpopup', ...
        'TooltipString',['Specifies whether data should be provided to all '... 
		         'Matlab instances once (Common), or if it is ' ...
		         'specific  for each evaluation.'], ...
	'Value',when);
h_source = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''inselect index'')', ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Max',1, ...
	'Min',1, ...
	'Position',[8 12 80 20], ...
	'String',' ', ...
	'Style','popupmenu', ...
	'Tag','sourcepopup', ...
	'TooltipString','Which data to send', ...
	'Value',source);
h_index = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'ListboxTop',0, ...
	'Max',1, ...
	'Min',1, ...
	'Position',[88 12 52 20], ...
	'String',' ', ...
	'Style','popupmenu', ...
	'Tag','indexpopup', ...
	'TooltipString','Index to the selected input source', ...
	'Value',ind);
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'ListboxTop',0, ...
	'Position',[132 96 56 20], ...
	'Callback',['if strcmp('''',deblank(get(findobj(gcbf,''Tag'',''varname''),''String'')))',...
		    'msgbox(''Name must be provided'',''Input Error'',''error'',''modal'');',...
		    'else, uiresume; end'],...
	'String','Ok', ...
	'Tag','okbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','closereq;', ...
	'ListboxTop',0, ...
	'Position',[132 72 56 20], ...
	'String','Cancel', ...
	'Tag','cancelbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 116 108 16], ...
	'String','Variable name', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 76 108 16], ...
	'String','Type of data', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 32 76 16], ...
	'String','Source of data', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[88 32 44 16], ...
	'String','Index', ...
	'Style','text', ...
	'Tag','StaticText1');

setsource(1);
funed(pmfun,'inselect index')
h = gcf;
uiwait(h);
if ismember(h, get(0,'children')) % not cancelled!
  cancel = 0;
  name = get(h_name,'String');
  when = get(h_when,'Value');
  source = get(h_source,'String');
  ind = get(h_index,'Value');
  source = source{get(h_source,'Value')};
  closereq;
end


% outselectgui
%------------

function [cancel,name,dest,ind] = outselectgui(name,dest,ind)
  
if nargin == 0
  ind = 1;
  dest = 1;
  name = '';
end

cancel = 1;

h0 = figure('Units','points', ...
	'Color',[0.8 0.8 0.8], ...
	'MenuBar','none', ...
	'Name','Select output destination', ...
	'NumberTitle','off', ...
	'PaperPosition',[18 180 576 432], ...
	'PaperUnits','points', ...
	'Position',[200 200 190 130], ...
	'Tag','outselect', ...
	'WindowStyle','modal'); %, ...
%	'ToolBar','none');
h_name = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 80 108 20], ...
	'String','', ...
	'Style','edit', ...
	'Tag','varname', ...
	'TooltipString','Name of the variable to retrieve from Matlab slave instance');
h_dest = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''outselect index'')', ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Max',1, ...
	'Min',1, ...
	'Position',[8 12 80 20], ...
	'String',{'SAVEFILE' ,'SETBLOC'}, ...
	'Style','popupmenu', ...
	'Tag','destpopup', ...
	'TooltipString','Which data to send', ...
	'Value',1);
h_index = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'ListboxTop',0, ...
	'Max',1, ...
	'Min',1, ...
	'Position',[88 12 52 20], ...
	'String',' ', ...
	'Style','popupmenu', ...
	'Tag','indexpopup', ...
	'TooltipString','Index to the selected input source', ...
	'Value',1);
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'ListboxTop',0, ...
	'Position',[132 80 56 20], ...
	'Callback',['if strcmp('''',deblank(get(findobj(gcbf,''Tag'',''varname''),''String'')))',...
		    'msgbox(''Name must be provided'',''Input Error'',''error'',''modal'');',...
		    'else, uiresume; end'],...
	'String','Ok', ...
	'Tag','okbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','closereq;', ...
	'ListboxTop',0, ...
	'Position',[132 56 56 20], ...
	'String','Cancel', ...
	'Tag','cancelbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 100 108 16], ...
	'String','Variable name', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 32 78 16], ...
	'String','Recipient', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[88 32 44 16], ...
	'String','Index', ...
	'Style','text', ...
	'Tag','StaticText1');

funed(pmfun,'outselect index')
h = gcf;
uiwait(h);
if ismember(h, get(0,'children')) % not cancelled!
  cancel = 0;
  name = get(h_name,'String');
  dest = get(h_dest,'String');
  ind = get(h_index,'Value');
  dest = dest{get(h_dest,'Value')};
  closereq;
end


% Add indices GUI
%----------------

function [] = createindgui(field,ind,len)

  % if it already exists, bring up to front and update a few fields.
  h0 = get(0,'children');
  for fig = h0'
    if strcmp(get(fig,'name'),'Index Creator');
      figure(fig);
      h_outptext = findobj(gcf,'tag','outptext');
      set(h_outptext,'String',[upper(field) '(' int2str(ind) ')'], ...
		     'Userdata',ind);
      return;
    end
  end

  % otherwise initialise
  
h0 = figure('Color',[0.8 0.8 0.8], ...
	'MenuBar','none', ...
	'Name','Index Creator', ...
	'NumberTitle','off', ...
	'PaperPosition',[18 180 576 432], ...
	'PaperUnits','points', ...
	'Position',[182 275 275 280], ...
	'Tag','Fig1', ...
	'ToolBar','none');
h1 = uicontrol('Parent',h0, ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'Callback',['set(findobj(gcbf,''Tag'',''indexradio1''),''Value'',0);set(gcbo,''Value'',1);set(findobj(gcbf,''Tag'',''indexdimedit''),''Enable'',''on'');set(findobj(gcbf,''Tag'',''matrixtypepopup''),''Enable'',''on'');set(findobj(gcbf,''Tag'',''wspopup''),''Enable'',''off'')'], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[16 191 105 25], ...
	'String','Virtual matrix', ...
	'Style','radiobutton', ...
	'Tag','indexradio2', ...
	'TooltipString','Create a virtual source');
h1 = uicontrol('Parent',h0, ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'Callback',['set(findobj(gcbf,''Tag'',''indexradio2''),''Value'',0);set(gcbo,''Value'',1);set(findobj(gcbf,''Tag'',''indexdimedit''),''Enable'',''off'');set(findobj(gcbf,''Tag'',''matrixtypepopup''),''Enable'',''off'');set(findobj(gcbf,''Tag'',''wspopup''),''Enable'',''on'',''String'',who,''Value'',1)'], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[16 216 105 25], ...
	'String','Real variable', ...
	'Style','radiobutton', ...
	'Tag','indexradio1', ...
	'TooltipString','Variable chosen from base workspace', ...
	'Value',1);
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'Enable','off', ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[100 152 68 20], ...
	'String','[10 10]', ...
	'Style','edit', ...
	'Tag','indexdimedit', ...
	'TooltipString','Dimensions of virtual source data');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[100 124 64 20], ...
	'String','[1 1]', ...
	'Style','edit', ...
	'Tag','blockdimedit', ...
	'TooltipString','Scalar value specifies number of blocks, vector specifies dimensions.');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'Enable','off', ...
	'ListboxTop',0, ...
	'Max',2, ...
	'Min',1, ...
	'Position',[168 152 36 20], ...
	'String',{'()','{}'}, ...
	'Style','popupmenu', ...
	'Tag','matrixtypepopup', ...
	'TooltipString','Type of matrix of virtual source data.', ...
	'Value',2);
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''index split'',gcbf)', ...
        'Interruptible','off', ...
	'ListboxTop',0, ...
	'Position',[164 124 40 20], ...
	'String','Split', ...
	'Tag','splitbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','get(gcbf,''UserData'')', ...
	'Enable','off', ...
	'ListboxTop',0, ...
	'Position',[160 88 44 20], ...
	'String','View', ...
	'Tag','viewbut', ...
	'TooltipString','Push to view indices');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 124.8 88.80000000000001 16.8], ...
	'String','Block specification:', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''attr commit'',gcf)', ...
	'Enable','off', ...
        'ListboxTop',0, ...
	'Position',[108 12 44 20], ...
	'String','Commit', ...
	'Tag','commitbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 192 72 16], ...
	'String','Source data:', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'ListboxTop',0, ...
	'Position',[11.2 86.40000000000001 128 32], ...
	'Style','frame', ...
	'Tag','Frame2');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[12 104 32 12], ...
	'String','Dims:', ...
	'Style','text', ...
	'Tag','StaticText3');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[12 92 84 12], ...
	'String','Number of blocks:', ...
	'Style','text', ...
	'Tag','StaticText3');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[92 92 44 12], ...
	'String','0', ...
	'Style','text', ...
	'Tag','numblocktext');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[40 104 96 12], ...
	'String','1 1', ...
	'Style','text', ...
	'Tag','numdimtext');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback',['if get(gco,''UserData'') & strcmp(''No'',' ...
		    'questdlg(''The most recently created indices have not been ' ...
		    'committed, do you still want to leave the Index Creator?'',' ...
		    '''Close Index Creator?'',''Yes'',''No'',''Yes'')), else closereq,end'], ...
	'ListboxTop',0, ...
	'Position',[160 12 44 20], ...
	'String','Done', ...
	'Tag','donebut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'ListboxTop',0, ...
	'Max',1, ...
	'Min',1, ...
	'Position',[100 172 104 20], ...
	'String',' ', ...
	'Style','popupmenu', ...
	'Tag','wspopup', ...
	'UserData','ans', ...
	'Value',1);
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 36 56 16], ...
	'String','Output into:', ...
	'Style','text', ...
	'Tag','statictext1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[60 36 145 16], ...
	'String',[upper(field) '(' int2str(ind) ')'], ...
	'Style','text', ...
	'UserData',ind, ...
	'Tag','outptext');


function [] = createfnamegui(field,ind,len)

  % if it already exists, bring up to front and update a few fields.
  h0 = get(0,'children');
  for fig = h0'
    if strcmp(get(fig,'name'),'Filename Creator');
      figure(fig);
      h_outptext = findobj(gcf,'tag','outptext');
      set(h_outptext,'String',[upper(field) '(' int2str(ind) ')'], ...
		     'Userdata',ind);
      return;
    end
  end

  % otherwise initialise

h0 = figure('Color',[0.8 0.8 0.8], ...
	'MenuBar','none', ...
	'Name','Filename Creator', ...
	'NumberTitle','off', ...
	'PaperPosition',[18 180 576 432], ...
	'PaperUnits','points', ...
	'Position',[571 175 310 280], ...
	'Tag','Fig1'); %, ...
%	'ToolBar','none');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[12 136 220 20], ...
	'Style','edit', ...
	'Tag','fileedit');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''fname browse'',gcbf)', ...
	'ListboxTop',0, ...
	'Position',[180 160 52 20], ...
	'String','Browse...', ...
	'Tag','browsebut');
h1 = uicontrol('Parent',h0, ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'Callback','set(findobj(gcbf,''Tag'',''filesourceradio2''),''Value'',0);set(gcbo,''Value'',1);', ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[16 226 120 24], ...
	'String','file mask', ...
	'Style','radiobutton', ...
	'Tag','filesourceradio1');
h1 = uicontrol('Parent',h0, ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'Callback','set(findobj(gcbf,''Tag'',''filesourceradio1''),''Value'',0);set(gcbo,''Value'',1);', ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[16 201 120 25], ...
	'String','specification file', ...
	'Style','radiobutton', ...
	'Tag','filesourceradio2', ...
	'Value',1);
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 28 44 16], ...
	'String',' ', ...
	'Style','text', ...
	'Tag','infilestatus');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[12 96 96 20], ...
	'Style','edit', ...
	'Tag','extedit');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 116 64 16], ...
	'String','Extension', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 200 164 16], ...
	'String','Source for filenames', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','get(gcbf,''UserData'')', ...
	'Enable','off', ...
	'ListboxTop',0, ...
	'Position',[12 12 52 20], ...
	'String','View', ...
	'Tag','viewbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
        'Callback','funed(pmfun,''fname create'',gcbf)', ...
        'ListboxTop',0, ...
	'Position',[180 96 52 20], ...
	'String','Create', ...
	'Tag','createbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','funed(pmfun,''attr commit'',gcbf)', ...
	'Enable','off', ...
	'ListboxTop',0, ...
	'Position',[84 12 52 20], ...
	'String','Commit', ...
	'Tag','commitbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback',['if get(gco,''UserData'') & strcmp(''No'',' ...
		    'questdlg(''The most recently created filenames have not been ' ...
		    'committed, do you still want to leave the Filename Creator?'',' ...
		    '''Close Filename Creator? '',''Yes'',''No'',''Yes'')), else closereq,end'], ...
	'ListboxTop',0, ...
	'Position',[180 12 52 20], ...
	'String','Done', ...
	'Tag','donebut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'ListboxTop',0, ...
	'Position',[16 48 212 40], ...
	'Style','frame', ...
	'Tag','Frame1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[20 68 124 16], ...
	'String','Number filenames created:', ...
	'Style','text', ...
	'Tag','StaticText2');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[140 68 84 16], ...
	'String','0', ...
	'Style','text', ...
        'UserData',len, ...
	'Tag','numblockstext');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[20 52 124 16], ...
	'String','Output into:', ...
	'Style','text', ...
	'Tag','StaticText2');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[72 52 152 16], ...
        'String',[upper(field) '(' int2str(ind) ')'], ...
	'Style','text', ...
        'UserData',ind, ...
        'Tag','outptext');






