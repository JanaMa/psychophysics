function [] = dispgui(varargin)
%DISPGUI user interface for PMJOB/DISPATCH, for internal use only.
  
h0 = get(0,'children');
for h = h0'
  if strcmp(get(h,'tag'),'dispatcher');
    % It exists already, just update it.
    
    switch varargin{1}
      
     %---------------- 
     case 'initialise'
      % varargin{2} contains the function vector.
      % varargin{3} contains the pmdconfig struct.
      
      figure(h); % bring it up front!
      job = varargin{2};
      for n=1:size(varargin{2},2),
	funs{n} = [int2str(n) ': ' job(n).expr];
      end
      h_funlist = findobj(h,'tag','funlist');
      set(h_funlist,'String',funs,'UserData',job);

      h_vmpopup = findobj(h,'tag','vmpopup');
      vmid = pmlistvm;
      vmlist = [];
      for n=1:length(vmid)
	vmlist = [vmlist ; {int2str(vmid(n))}];
      end
      vmlist = [{'All'} ; vmlist];
      v = get(h_vmpopup,'Value');
      set(h_vmpopup,'String',vmlist,'Value',min(length(vmlist),v),'Max',length(vmlist))

      set(findobj(h,'tag','intervedit'),'String',int2str(varargin{3}.saveinterv));
      set(findobj(h,'tag','debugcheck'),'Value',varargin{3}.debug);
      set(findobj(h,'tag','timestarttext'),'String',datestr(now,0));
      set(findobj(h,'tag','logfiletext'),'String',varargin{3}.logfile);
      set(findobj(h,'tag','statefiletext'),'String',varargin{3}.statefile);
	
      dispgui('refresh pms')
      
     %---------------- 
     case 'refresh pms'
      
     %---------------- 
     case 'statusline'
      % varargin{2} = string to output.
      set(findobj(h,'tag','statusline'),'String',varargin{2});
      
      
     %---------------- 
     case 'disp err'
      % not implemented
      
     %---------------- 
     case 'eval'
      % not implemented
      
     %---------------- 
     case 'stop dispatch'
      if strcmp('No',questdlg(['Are you sure you want to exit the dispatcher?    ' ;
		               'Dispatching can be resumed from last saved state.'], ...
			      'Exit Dispatcher?','Yes','No','Yes'))
	return
      end
      dispatch(pmjob,'inputgui','gui_break=1;')
      closereq
      
    end
    return;
  end
end

% otherwise initialise


h0 = figure('Color',[0.8 0.8 0.8], ...
	'FileName','dispguilayout.m', ...
	'MenuBar','none', ...
	'Name','Parallel Matlab Dispatcher', ...
	'NumberTitle','off', ...
	'PaperPosition',[18 180 576 432], ...
	'PaperUnits','points', ...
	'Position',[642 544 560 293], ...
	'RendererMode','manual', ...
	'Tag','dispatcher', ...
	'ToolBar','none');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'ListboxTop',0, ...
	'Position',[8 132 432 88], ...
	'Style','frame', ...
	'Tag','Frame1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'HorizontalAlignment','left', ...
	'Position',[12 160 424 52], ...
	'Style','listbox', ...
	'Tag','funlist', ...
	'Value',1);
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[12 212 108 16], ...
	'String','Dispatching Functions', ...
	'Style','text', ...
	'Tag','StaticText1', ...
	'TooltipString','Index, Virtual Machine(s), Evaluation Expression');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','dispgui(''stop dispatch'')', ...
	'ListboxTop',0, ...
	'Position',[344 8 92 20], ...
	'String','Stop dispatching', ...
	'Tag','cancelbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','dispatch(pmjob,''setconfig'',''Debug'',get(gco,''Value''));', ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 32 92 20], ...
	'String','Debug mode', ...
	'Style','checkbox', ...
	'Tag','debugcheck', ...
	'Value',1);
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 60 96 16], ...
	'String','Save state interval:', ...
	'Style','text', ...
	'Tag','statetext', ...
	'TooltipString','');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'ListboxTop',0, ...
	'Position',[8 88 432 24], ...
	'Style','frame', ...
	'Tag','Frame2');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[12 92 424 16], ...
	'Style','text', ...
	'Tag','statusline');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[8 112 60 16], ...
	'String','Status line', ...
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[16 140 72 16], ...
	'String','Time started:', ...
	'Style','text', ...
	'Tag','StaticText1', ...
	'TooltipString','Hostname, ID, Architecture');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[1 1 1], ...
	'Callback','dispatch(pmjob,''setconfig'',''Saveinterv'',str2num(get(gco,''String'')));', ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[100 60 44 20], ...
	'String','10', ...
	'Style','edit', ...
	'Tag','intervedit');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[80 140 136 16], ...
	'String','0', ...
	'Style','text', ...
	'Tag','timestarttext');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
	'Callback','pmcfg', ...
	'ListboxTop',0, ...
	'Position',[8 8 92 20], ...
	'String','System Config', ...
	'Tag','syscfgbut');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[148 60 48 16], ...
	'String','State file:', ...
	'Style','text', ...
	'Tag','statetext', ...
	'TooltipString','');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[196 60 236 16], ...
	'Style','text', ...
	'Tag','statefiletext', ...
	'TooltipString','');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[196 44 236 16], ...
	'Style','text', ...
	'Tag','logfiletext', ...
	'TooltipString','');
h1 = uicontrol('Parent',h0, ...
	'Units','points', ...
	'BackgroundColor',[0.8 0.8 0.8], ...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[148 44 48 16], ...
	'String','Log file:', ...
	'Style','text', ...
	'Tag','statetext', ...
	'TooltipString','');
% $$$ h1 = uicontrol('Parent',h0, ...
% $$$ 	'Units','points', ...
% $$$ 	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
% $$$ 	'Callback','dispgui(''disp err'')', ...
% $$$ 	'ListboxTop',0, ...
% $$$ 	'Position',[120 8 92 20], ...
% $$$ 	'String','Display Errors', ...
% $$$ 	'Tag','disperrbut');
% $$$ h1 = uicontrol('Parent',h0, ...
% $$$ 	'Units','points', ...
% $$$ 	'BackgroundColor',[0.701960784313725 0.701960784313725 0.701960784313725], ...
% $$$ 	'Callback','dispgui(''eval'')', ...
% $$$ 	'ListboxTop',0, ...
% $$$ 	'Position',[232 8 92 20], ...
% $$$ 	'String','Eval Output', ...
% $$$ 	'Tag','evalbut');

dispgui('initialise',varargin{:})
